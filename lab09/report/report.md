---
## Front matter
title: "Отчёт по лабораторной работе №9"
subtitle: "Управление SELinux"
author: "Ришард Когенгар"

## Generic otions
lang: ru-RU
toc-title: "Содержание"

## Bibliography
bibliography: bib/cite.bib
csl: pandoc/csl/gost-r-7-0-5-2008-numeric.csl

## Pdf output format
toc: true
toc-depth: 2
lof: true
lot: true
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
    - spelling=modern
    - babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Biblatex
biblatex: true
biblio-style: "gost-numeric"
biblatexoptions:
  - parentracker=true
  - backend=biber
  - hyperref=auto
  - language=auto
  - autolang=other*
  - citestyle=gost-numeric
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float}
  - \floatplacement{figure}{H}
---

# Цель работы

Получить навыки работы с контекстом безопасности и политиками SELinux.

# Ход выполнения

## Управление режимами SELinux

1. После загрузки операционной системы был запущен терминал и получены полномочия администратора.  
   Получение прав суперпользователя необходимо для выполнения операций администрирования SELinux, так как управление режимами работы и конфигурацией системы безопасности доступно только пользователю root.

2. Для просмотра текущего состояния SELinux была выполнена команда `sestatus -v`.  
   На экране была выведена подробная информация о состоянии системы безопасности:

   - SELinux status: enabled — механизм SELinux включён и функционирует.
   - SELinuxfs mount: /sys/fs/selinux — файловая система SELinux успешно смонтирована.
   - SELinux root directory: /etc/selinux — каталог с конфигурационными файлами SELinux.
   - Loaded policy name: targeted — используется целевая политика, защищающая основные системные службы.
   - Current mode: enforcing — SELinux работает в режиме принудительного исполнения политик.
   - Mode from config file: enforcing — в конфигурационном файле также указан режим enforcing.
   - Policy MLS status: enabled — поддержка многоуровневой модели безопасности активна.
   - Policy deny_unknown status: allowed — неизвестные действия разрешены, если не запрещены политикой.
   - Memory protection checking: actual (secure) — активна проверка защиты памяти.
   - Max kernel policy version: 33 — версия политики SELinux, поддерживаемая ядром.

   Дополнительно отображены контексты процессов и системных файлов, включая init, sshd, /etc/passwd и /etc/shadow.

   ![Проверка состояния SELinux](Screenshot_1.png)

3. Для определения текущего режима работы SELinux была использована команда `getenforce`.  
   В ответ было получено значение Enforcing, что подтверждает работу SELinux в режиме строгого контроля.

4. Далее SELinux был временно переведён в разрешающий режим.  
   После выполнения команды смены режима и повторной проверки было установлено, что система перешла в состояние Permissive.  
   В данном режиме SELinux не блокирует операции, нарушающие политики, а только фиксирует их в журналах.

   ![Переключение SELinux в режим Permissive](Screenshot_1.png)

5. Для полного отключения SELinux был отредактирован конфигурационный файл `/etc/sysconfig/selinux`.  
   Параметр SELINUX был установлен в значение disabled.  
   После сохранения изменений система была перезагружена.

   ![Отключение SELinux через конфигурационный файл](Screenshot_2.png)

6. После перезагрузки системы снова был открыт терминал и получены права администратора.  
   Проверка состояния SELinux показала значение Disabled, что подтверждает его полное отключение.

   ![SELinux отключён](Screenshot_3.png)

7. Была предпринята попытка переключить режим SELinux.  
   Система выдала сообщение о том, что SELinux отключён, и отказалась менять режим.  
   Это подтверждает невозможность переключения режимов без перезагрузки, если SELinux был отключён на уровне конфигурации.

8. Для повторного включения SELinux файл `/etc/sysconfig/selinux` был вновь отредактирован.  
   Параметр SELINUX был установлен в значение enforcing.  
   После этого система была перезагружена.

   ![Включение SELinux в режиме enforcing](Screenshot_4.png)

9. Во время загрузки системы было выведено предупреждение о необходимости восстановления меток безопасности SELinux.  
   Служба selinux-autorelabel автоматически запустила процесс перемаркировки файловой системы, который может занимать продолжительное время.

   ![Процесс автоматической перемаркировки SELinux](Screenshot_5.png)

10. После завершения загрузки была повторно выполнена проверка состояния SELinux.  
    Было подтверждено, что система работает в режиме enforcing, а политика безопасности успешно загружена.

    ![SELinux работает в режиме enforcing](Screenshot_6.png)

## Использование restorecon для восстановления контекста безопасности

1. В терминале с правами администратора был проверен контекст безопасности файла `/etc/hosts`.  
   Было установлено, что файл имеет корректный тип контекста net_conf_t.

   ![Контекст безопасности файла /etc/hosts](Screenshot_7.png)

2. Файл `/etc/hosts` был скопирован в домашний каталог пользователя.  
   Проверка контекста показала, что файл `~/hosts` получил тип admin_home_t, так как копирование рассматривается системой как создание нового файла.

3. Далее файл из домашнего каталога был перемещён обратно в каталог `/etc` с подтверждением перезаписи.  
   Проверка показала, что контекст безопасности остался неверным и по-прежнему соответствует admin_home_t.

4. Для восстановления корректного контекста безопасности была использована утилита restorecon.  
   В процессе выполнения было выведено сообщение об изменении контекста файла.

5. Повторная проверка подтвердила, что файл `/etc/hosts` снова имеет корректный контекст net_conf_t.

6. Для массового восстановления контекстов безопасности файловой системы был создан файл `.autorelabel` в корневом каталоге.  
   После перезагрузки системы была автоматически выполнена полная перемаркировка файлов, что отображалось в загрузочных сообщениях.

   ![Процесс автоматической перемаркировки SELinux](Screenshot_8.png)

## Настройка контекста безопасности для нестандартного расположения файлов веб-сервера

1. Был запущен терминал и получены полномочия администратора.  
   Это необходимо для установки программного обеспечения, изменения конфигурации веб-сервера и управления политиками SELinux.

2. В системе было установлено необходимое программное обеспечение: веб-сервер Apache (httpd) и текстовый браузер lynx.  
   Установка данных пакетов позволяет развернуть локальный HTTP-сервер и проверить его работу из консоли.

3. Для размещения файлов веб-сервера был создан новый каталог `/web`.  
   Данный каталог используется в качестве альтернативного корневого каталога (DocumentRoot) для Apache.

4. В каталоге `/web` был создан файл `index.html`.  
   В файл был помещён текст `Welcome to my web-server`, который должен отображаться при обращении к веб-серверу.

5. Был отредактирован конфигурационный файл `/etc/httpd/conf/httpd.conf`.  
   Стандартная директива `DocumentRoot "/var/www/html"` была закомментирована, после чего ниже добавлена директива `DocumentRoot "/web"`.  
   Также был закомментирован стандартный раздел `<Directory "/var/www">`, определяющий правила доступа, и добавлен новый раздел `<Directory "/web">`, разрешающий доступ ко всем файлам в данном каталоге.

   ![Изменение конфигурации Apache](Screenshot_9.png)

6. После изменения конфигурации веб-сервер Apache был запущен и добавлен в автозагрузку системы.  
   Это обеспечивает автоматический запуск службы httpd при каждом старте системы.

7. Под учётной записью обычного пользователя был выполнен запрос к веб-серверу с помощью текстового браузера lynx.  
   В результате была отображена стандартная тестовая страница Rocky Linux, а не содержимое созданного файла `index.html`.  
   Это свидетельствует о том, что SELinux блокирует доступ Apache к каталогу `/web` из-за отсутствия корректного контекста безопасности.

   ![Стандартная страница Apache](Screenshot_10.png)

8. Для разрешения доступа веб-серверу к нестандартному каталогу была добавлена новая запись контекста безопасности SELinux.  
   Для каталога `/web` и всех его вложенных файлов был назначен тип контекста `httpd_sys_content_t`, используемый для статического контента Apache.

9. После назначения нового контекста была выполнена операция восстановления меток безопасности для каталога `/web`.  
   В процессе было отображено сообщение о смене контекста каталога и файла `index.html`.

   ![Назначение и восстановление контекста SELinux](Screenshot_11.png)

10. После этого под учётной записью пользователя был повторно выполнен запрос к веб-серверу с помощью lynx.  
    В результате на экране была успешно отображена пользовательская веб-страница с текстом `Welcome to my web-server`, что подтверждает корректную настройку контекста безопасности.

    ![Пользовательская веб-страница](Screenshot_12.png)

## Работа с переключателями SELinux

1. В терминале с правами администратора был просмотрен список переключателей SELinux, относящихся к службе FTP.  
   Был обнаружен переключатель `ftpd_anon_write`, имеющий значение off, что означает запрет анонимной записи через FTP.

2. Далее был выведен список переключателей службы `ftpd_anon` с пояснениями.  
   Было установлено, что параметр `ftpd_anon_write` отвечает за разрешение анонимной записи и по умолчанию отключён как во временной, так и в постоянной конфигурации.

3. Значение переключателя `ftpd_anon_write` было изменено с off на on для текущего сеанса работы системы.  
   После этого проверка показала, что переключатель включён, однако постоянное значение по-прежнему остаётся отключённым.

4. Для сохранения изменения после перезагрузки системы переключатель `ftpd_anon_write` был включён в постоянной конфигурации.  
   Это обеспечивает сохранение разрешения анонимной записи для FTP-службы даже после перезапуска системы.

5. Повторная проверка списка переключателей показала, что `ftpd_anon_write` имеет состояние on как для временной, так и для постоянной настройки.  
   Это означает, что анонимная запись через FTP разрешена и настройка сохранена на постоянной основе.

   ![Работа с переключателями SELinux](Screenshot_13.png)

## Вывод

В ходе работы были изучены механизмы настройки SELinux для доступа к нестандартным каталогам веб-сервера и управления логическими переключателями безопасности. Настройка контекстов и переключателей позволила обеспечить корректную работу служб без отключения SELinux, сохранив требуемый уровень защиты системы.

# Контрольные вопросы

**1. Вы хотите временно поставить SELinux в разрешающем режиме. Какую команду вы используете?**

Для временного перевода SELinux в разрешающий режим используется команда  
`setenforce 0`  

Данная команда переключает SELinux в режим Permissive до следующей перезагрузки системы или изменения режима обратно.

**2. Вам нужен список всех доступных переключателей SELinux. Какую команду вы используете?**

Для просмотра всех доступных переключателей SELinux применяется команда  
`getsebool -a`  

Она выводит полный список boolean-переключателей и их текущие значения.

**3. Каково имя пакета, который требуется установить для получения легко читаемых сообщений журнала SELinux в журнале аудита?**

Для получения человекочитаемых сообщений SELinux необходимо установить пакет  
`setroubleshoot-server`  

Он позволяет анализировать события SELinux и формировать подробные пояснения к ним.

**4. Какие команды вам нужно выполнить, чтобы применить тип контекста `httpd_sys_content_t` к каталогу `/web`?**

Для применения корректного контекста безопасности к каталогу `/web` необходимо:
- добавить правило контекста для каталога и его содержимого;
- восстановить контексты безопасности на файловой системе.

Используются команды `semanage fcontext` и `restorecon`.

**5. Какой файл вам нужно изменить, если вы хотите полностью отключить SELinux?**

Для полного отключения SELinux необходимо изменить конфигурационный файл  
`/etc/sysconfig/selinux`  

В данном файле параметр `SELINUX` устанавливается в значение `disabled`.

**6. Где SELinux регистрирует все свои сообщения?**

Все сообщения SELinux регистрируются в журнале аудита системы, который хранится в файле  
`/var/log/audit/audit.log`  

Дополнительно сообщения могут дублироваться в системный журнал.

**7. Вы не знаете, какие типы контекстов доступны для службы FTP. Какая команда позволяет получить более конкретную информацию?**

Для получения подробной информации о переключателях и параметрах SELinux, связанных со службой FTP, используется команда  
`semanage boolean -l | grep ftp`  

Она отображает описание каждого переключателя и его текущее состояние.

**8. Ваш сервис работает не так, как ожидалось, и вы хотите узнать, связано ли это с SELinux или чем-то ещё. Какой самый простой способ узнать?**

Самый простой способ — временно перевести SELinux в разрешающий режим с помощью `setenforce 0`.  
Если после этого сервис начинает работать корректно, значит проблема связана с политиками SELinux.
